# 简介

在JDK 1.2版之后，Java对引用的概念进行了扩充，将引用分为强引用(Strong Reference)、软引用(Soft Reference)、弱引用(weak Reference)和虚引用(Phantom Reference）4种，**这4种引用强度依次逐渐减弱**。

除强引用外，其他3种引用均可以在java.lang.ref包中找到它们的身影。如下图，显示了这3种引用类型对应的类，开发人员可以在应用程序中直接使用它们。

<center><img src="https://ss.im5i.com/2021/08/19/VDFJn.png" alt="VDFJn.png" border="0" /></center>

- 定义虚拟机中的对象可能的三种状态：
  - **可触及的**：从根节点开始，可以到达这个对象
  - **可复活的**：对象的所有引用都被释放，但是对象有可能在`finalize()`中复活
  - **不可触及的**：对象的`finalize()`被调用，并且没有复活，那么就会进入不可触及状态。不可触及的对象不可能被复活，**因为`finalize()`只会被调用一次**
- 以上3种状态，是由于`finalize()`方法的存在，进行的区分。只有在对象不可触及时才可以被回收

# 强引用

强引用(StrongReference)：

- 最传统的“引用”的定义，是指在程序代码之中普遍存在的引用赋值，即类似`object obj=new object()`这种引用关系。无论任何情况下，只要强引用关系还存在，垃圾收集器就永远不会回收掉被引用的对象
- 虚拟机宁愿抛出OOM异常，也不会回收强引用所指向对象
- **强引用是造成Java内存泄漏的主要原因之一**
- 可被回收：显式的将相应强引用赋值为`null`

# 软引用

软引用(SoftReference)：

- 在系统将要发生内存溢出之前，将会把这些对象列入回收范围之中进行第二次回收。如果这次回收后还没有足够的内存，才会抛出内存溢出异常
- 软引用通常用来描述一些还有用，但**非必需的对象**
- 通常用来实现内存敏感的缓存。比如：**高速缓存**就有用到软引用，如果还有空闲内存，就可以暂时保留缓存，当内存不足时清理掉，这样就保证使用缓存的同时，不会耗尽内存

```java
Object obj = new Object();   // 声明强引用
SoftReference<Object> sf = new SoftReference<>(obj);
obj = null; // 销毁强引用
```



# 弱引用

弱引用(weakReference)：

- 被弱引用关联的对象只能生存到下一次垃圾收集之前。当垃圾收集器工作时，无论内存空间是否足够，都会回收掉被弱引用关联的对象
- 弱引用也是用来描述那些**非必需对象**
- 软、弱引用都非常适合来保存那些可有可无的缓存数据
- **软引用对象与弱引用对象最大的不同**：当GC进行回收时，软引用对象需要通过算法检查是否回收，弱引用对象GC总是进行回收

```java
Object obj = new Object();   // 声明强引用
WeakReference<Object> wr = new WeakReference<>(obj);
obj = null; // 销毁强引用
```



# 虚引用

虚引用(PhantomReference)：

- **一个对象是否有虚引用的存在，完全不会决定对象的生命周期**，也无法通过虚引用来获得一个对象的实例。为一个对象设置虚引用关联的唯一目的在于**跟踪垃圾回收过程**，比如：能在这个对象被收集器回收时收到一个系统通知
- 虚引用必须和引用队列一起使用
- **由于虚引用可以跟踪对象的回收时间，因此，也可以将一些资源释放操作放置在虚引用中执行和记录**

```java
Object obj = new Object();
ReferenceQueue phantomQueue = new ReferenceQueue();
PhantomReference<Object> pf = new PhantomReference<>(obj, phantomQueue);
obj = null;
```



# 总结

|  引用  |    回收策略    | 场景             |
| :----: | :------------: | :--------------- |
| 强引用 |     不回收     | 99%属于强引用    |
| 软引用 | 内存不足即回收 | 缓存场景         |
| 弱引用 |   发现即回收   | 缓存场景         |
| 虚引用 |                | 用于对象回收跟踪 |


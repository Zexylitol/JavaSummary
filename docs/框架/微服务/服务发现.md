# 1 理解服务发现

## 1.1 微服务架构

为适应企业的业务发展，提高软件研发的生产力，降低软件研发的成本，软件架构也作了升级和优化，<font color="red">将一个独立的系统拆分成若干小的服务，每个小服务运行在不同的进程中，服务与服务之间采用RESTful、RPC等协议传输数据，每个服务所拥有的功能具有独立性强的特点，这样的设计就实现了单个服务的高内聚，服务与服务之间的低耦合效果，这些小服务就是微服务</font>，基于这种方法设计的系统架构即微服务架构。
下图是基于微服务架构的电商系统：  

<center><img src="https://i.im5i.com/2021/06/12/66H4z.png" alt="66H4z.png" border="0" /></center>

特点： 

- 服务层按业务拆分为一个一个的微服务
- 微服务的职责单一
- 微服务之间采用RESTful、RPC等轻量级协议传输
- 有利于采用前后端分离架构。

## 1.2 服务发现流程

<font color="red">在微服务架构中，整个系统会按职责能力划分为多个服务，通过服务之间协作来实现业务目标</font>。这样在我们的代码中免不了要进行**服务间的远程调用**，服务的消费方要调用服务的生产方，为了完成一次请求，消费方需要知道服务生产方的**网络位置(IP地址和端口号)**。  

微服务可能是部署在云环境的，服务实例的网络位置或许是动态分配的。另外，每一个服务一般会有多个实例来做负载均衡，由于宕机或升级，服务实例网络地址会经常动态改变。再者，每一个服务也可能应对临时访问压力增加新的服务节点。正如下图所示：

<center><img src="https://i.im5i.com/2021/06/12/66TK5.png" alt="66TK5.png" border="0" /></center>

<font color="red">基于以上的问题，服务之间如何相互发现？服务如何管理？这就是服务发现的问题了。</font>
服务发现就是服务消费方通过<font color="blue">服务发现中心</font>智能发现服务提供方，从而进行远程调用的过程。如下图：

<center><img src="https://i.im5i.com/2021/06/12/66Wj6.png" alt="66Wj6.png" border="0" /></center>

上图中服务实例本身并不记录服务生产方的网络地址，所有服务实例内部都会包含服务发现客户端。

- 在每个服务启动时会向**服务发现中心**上报自己的网络位置。这样，在服务发现中心内部会形成一个**服务注册表**，服务注册表是服务发现的核心部分，**是包含所有服务实例的网络地址的数据库**。  
- **服务发现客户端**会定期从**服务发现中心**同步**服务注册表** ，并缓存在客户端。  
- 当需要对某服务进行请求时，服务实例通过该注册表，定位目标服务网络地址。若目标服务存在多个网络地址，则使用**负载均衡算法**从多个服务实例中选择出一个，然后发出请求  

总结，在微服务环境中，由于**服务运行实例的网络地址是不断动态变化**的，**服务实例数量的动态变化** ，因此**无法使用固定的配置文件**来记录服务提供方的网络地址，必须使用动态的服务发现机制用于实现微服务间的**相互感知**。各服务实例会上报自己的网络地址，这样服务中心就形成了一个完整的服务注册表，各服务实例会通过**服务发现中心**来获取访问目标服务的网络地址，从而实现**服务发现**的机制。  

# 2 Nacos服务发现

## 2.1 服务发现产品对比

目前市面上用的比较多的服务发现中心有：Nacos、Eureka、Consul和Zookeeper。  

<center><img src="https://i.im5i.com/2021/06/12/66XL8.png" alt="66XL8.png" border="0" /></center>

## 2.2 Nacos简介

Nacos是阿里的一个开源产品，它是针对微服务架构中的服务发现、配置管理、服务治理的综合型解决方案。  

官方介绍是这样的：

> Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您实现动态服务发现、服务配置管理、服务及流量管理。 Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。Nacos 是构建以“服务”为中心的现代应用架构的服务基础设施。

官网地址：https://nacos.io  

## 2.3 Nacos特性

Nacos主要提供以下四大功能：
a. **服务发现与服务健康检查**

- Nacos使服务更容易注册，并通过DNS或HTTP接口发现其他服务，Nacos还提供服务的实时健康检查，以防止向不健康的主机或服务实例发送请求。

b. **动态配置管理**

- 动态配置服务允许您在所有环境中以集中和动态的方式管理所有服务的配置。Nacos消除了在更新配置时重新部署应用程序，这使配置的更改更加高效和灵活。

c. **动态DNS服务**

- Nacos提供基于DNS 协议的服务发现能力，旨在支持异构语言的服务发现，支持将注册在Nacos上的服务以域名的方式暴露端点，让三方应用方便的查阅及发现。

d. 服务和元数据管理

- Nacos 能让您从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略。

这里a、c、d说明了服务发现的功能特性。  

## 2.4 Dubbo服务发现

Dubbo是阿里巴巴公司开源的RPC框架，在国内有着非常大的用户群体。

RPC：远程过程调用（Remote Procedure Call）的缩写形式，调用RPC远程方法就像调用本地方法一样，非常方便  

下图是微服务采用Dubbo协议的系统架构图：  

<center><img src="https://i.im5i.com/2021/06/13/66YZZ.png" alt="66YZZ.png" border="0" /></center>

组件说明：
1、客户端：前端或外部系统
2、API网关：系统唯一入口，路由转发
3、application-1 ：应用1，前端提供Http接口，接收用户的交互请求
4、service-1 ：微服务1，提供业务逻辑处理服务
5、service-2：微服务2，提供业务逻辑处理服务
交互流程：
1、网关负责客户端请求的统一入口，路由转发，前端通过网关请求后端服务。
2、网关收到前端请求，转发请求给应用。
3、应用接收前端请求，调用微服务进行业务逻辑处理
4、微服务为应用提供业务逻辑处理的支撑，为应用提供Dubbo协议接口  

优势分析：
此架构同时提供RESTful和Dubbo接口服务，应用层对前端提供RESTful接口，RESTful是互联网通用的轻量级交互协议，方便前端接入系统；微服务层向应用层提供Dubbo接口，Dubbo接口基于RPC通信协议速度更快。

此架构采用阿里开源的Nacos，集服务发现和配置中心于一身，支持RESTful及Dubbo服务的注册。

## 2.5 服务发现数据模型

### 2.5.1Namespace 隔离设计

命名空间Namespace 的常用场景之一是不同环境的隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。

- 从一个用户的角度来看，如果有多套不同的环境，那么这个时候可以根据指定的环境来创建不同的namespce，以此来实现**多环境的隔离**。例如，你可能有开发，测试和生产三个不同的环境，那么使用一套nacos 集群可以分别建以下三个不同的 namespace。如下图所示：

<center><img src="https://i.im5i.com/2021/06/13/663y1.png" alt="663y1.png" border="0" /></center>

- 从多个用户的角度来看，每个用户可能会有自己的 namespace,每个用户的配置数据以及注册的服务数据都会归属到自己的namespace 下，以此来实现多用户间的数据隔离。例如超级管理员分配了三个用户，分别为张三、李四和王五。分配好了之后，各用户用自己的账户名和密码登录后，创建自己的命名空间。如下图所示：  

<center><img src="https://i.im5i.com/2021/06/13/66IRn.png" alt="66IRn.png" border="0" /></center>

### 2.5.2 数据模型  

Nacos在经过阿里内部多年生产经验后提炼出的数据模型，则是一种服务-集群-实例的三层模型，这样基本可以满足服务在所有场景下的数据存储和管理。  

<center><img src="https://i.im5i.com/2021/06/13/66Zpl.png" alt="66Zpl.png" border="0" /></center>

nacos服务发现的数据模型如下：
**服务**
对外提供的软件功能，通过网络访问预定义的接口。  

**服务名**
服务提供的标识，通过该标识可以唯一确定要访问的服务。

**实例**
提供一个或多个服务的具有可访问网络地址（IP:Port）的进程，启动一个服务，就产生了一个服务实例。

**元信息**
Nacos数据（如配置和服务）描述信息，如服务版本、权重、容灾策略、负载均衡策略、鉴权配置、各种自定义标签 (label)，从作用范围来看，分为服务级别的元信息、集群的元信息及实例的元信息。

**集群**
服务实例的集合，服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群，相同集群下的实例才能相互感知。  

# 3 小结

Nacos用来干什么？
Nacos是阿里巴巴公司开源的项目，它用来实现配置中心和服务注册中心。

什么是服务发现？
在微服务架构中一个业务流程需要多个微服务通过网络接口调用完成业务处理，服务消费方从服务注册中心获取服务提供方的地址，从而进行远程调用，这个过程叫做服务发现。

服务发现的流程是什么？
1、服务发现的客户端从服务注册中心获取服务列表
2、服务消费方通过客户端负载均衡获取服务实例地址，进行远程调用。  

# Reference

- [黑马程序员Java大型分布式微服务闪聚支付项目](https://www.bilibili.com/video/BV17v411V79c?p=31&spm_id_from=pageDriver)

